import { createApp } from 'vue-demi';
import { createPinia, setActivePinia } from 'pinia';

function createTestingPinia({
  initialState = {},
  plugins = [],
  stubActions = true,
  stubPatch = false,
  fakeApp = false,
  createSpy: _createSpy
} = {}) {
  const pinia = createPinia();
  pinia.use(({ store }) => {
    if (initialState[store.$id]) {
      store.$patch(initialState[store.$id]);
    }
  });
  plugins.forEach((plugin) => pinia.use(plugin));
  const createSpy = _createSpy || typeof jest !== "undefined" && jest.fn;
  if (!createSpy) {
    throw new Error("You must configure the `createSpy` option.");
  }
  pinia.use(({ store, options }) => {
    Object.keys(options.actions).forEach((action) => {
      store[action] = stubActions ? createSpy() : createSpy(store[action]);
    });
    store.$patch = stubPatch ? createSpy() : createSpy(store.$patch);
  });
  if (fakeApp) {
    const app = createApp({});
    app.use(pinia);
  }
  pinia._testing = true;
  setActivePinia(pinia);
  Object.defineProperty(pinia, "app", {
    configurable: true,
    enumerable: true,
    get() {
      return this._a;
    }
  });
  return pinia;
}

export { createTestingPinia };
